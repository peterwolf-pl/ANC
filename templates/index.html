<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Art Numeric Code</title>

  <link rel="icon" type="image/png" href="/static/ico.png">

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; max-width: 1100px; }
    .header { display:flex; align-items:center; gap:14px; margin-bottom: 6px; }
    .header img { height: 44px; width: auto; display:block; }
    .tabs { display:flex; gap:10px; margin-bottom: 4px; flex-wrap: wrap; }
    .tab { padding:10px 14px; border:1px solid #222; background:#fff; cursor:pointer; border-radius: 10px; }
    .tab.active { background:#111; color:#fff; }
    .panel { display:none; }
    .panel.active { display:block; }

    textarea { width: 100%; height: 260px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .row > * { margin: 6px 0; }
    .btn { padding: 10px 14px; border: 1px solid #222; background: #fff; cursor: pointer; border-radius: 10px; }
    .btn:active { transform: translateY(1px); }
    .btn.dark { background:#111; color:#fff; }
    .pill { display: inline-block; padding: 6px 10px; border: 1px solid #ddd; border-radius: 999px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .box { border: 1px solid #ddd; padding: 12px; border-radius: 14px; background:#fff; }
    .err { color: #b00020; font-weight: 700; }
    .small { opacity: 0.8; font-size: 13px; }
    input, select { padding: 8px 10px; border:1px solid #ddd; border-radius: 10px; }

    .divider { margin: 10px 0; border-top: 1px solid #eee; }

    /* Settings list */
    .setting-list { display:flex; flex-direction: column; gap: 10px; }
    .setting-item {
      display:flex; gap:10px; align-items:center; justify-content: space-between;
      padding:10px; border:1px solid #eee; border-radius:12px; background:#fff;
    }
    .setting-item .label { display:flex; flex-direction:column; gap:2px; min-width:0; }
    .setting-item .label b { font-size:13px; font-weight:650; }
    .setting-item .label span { font-size:12px; opacity:0.75; }
    .setting-item .control { flex: 0 0 180px; display:flex; justify-content:flex-end; }
    .setting-item .control input, .setting-item .control select { width: 180px; box-sizing:border-box; }
    .setting-item .control input[type="checkbox"] { transform: scale(1.2); width:auto; }

    /* Generator: settings scroll, preview full width and full height */
    .gen-vertical { display:flex; flex-direction: column; gap: 12px; }
    .gen-settings-scroll { max-height: 380px; overflow: auto; padding-right: 6px; }

    .preview-fullwidth {
      width: 100vw;
      margin-left: calc(50% - 50vw);
      margin-right: calc(50% - 50vw);
    }

    .preview-area {
      height: calc(100vh - 240px);
      min-height: 520px;
      border: 1px solid #eee;
      border-radius: 14px;
      overflow: hidden;
      background: #fafafa;
      position: relative;
    }

    .preview-area img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      background: #fafafa;
    }

    /* Simulator canvas on top of preview image */
    .simCanvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .sim-controls {
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 10px;
    }
    .sim-controls input[type="range"] { width: 220px; }

    /* Jog UI */
    .jog-wrap { display:flex; gap: 12px; flex-wrap: wrap; align-items: flex-start; }
    .jog-pad {
      display: grid;
      grid-template-columns: 60px 60px 60px;
      grid-template-rows: 46px 46px 46px;
      gap: 8px;
      align-items: center;
      justify-items: center;
    }
    .jog-pad button { width: 60px; height: 46px; }
    .jog-meta { display:flex; flex-direction: column; gap: 10px; min-width: 320px; }
    .jog-meta input { width: 120px; }
    .jog-actions { display:flex; gap: 10px; flex-wrap: wrap; align-items: center; }

    @media (max-width: 980px) {
      .gen-settings-scroll { max-height: none; overflow: visible; padding-right: 0; }
      .preview-area { height: 60vh; min-height: 320px; }
      .preview-fullwidth { width: 100%; margin-left: 0; margin-right: 0; }
      .sim-controls input[type="range"] { width: 160px; }
    }
  </style>
</head>
<body>

  <div class="header">
    <img src="/static/logo.png" alt="logo">
    <div>
      <h1 style="margin:0;">artNC</h1>
      <div class="small">unrestricted and unattended numerically controlled machine system by peterwolf.pl</div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="sender">Printer</button>
    <button class="tab" data-tab="generator">Generator PNG</button>
    <button class="tab" data-tab="text">Text outline</button>
  </div>

  <!-- Sender -->
  <div class="panel active" id="panel-sender">
    <div class="box">
      <div class="row">
        <label>Host: <input id="host" value="192.168.4.1"></label>
        <label>Port: <input id="port" value="23" inputmode="numeric"></label>
        <button class="btn" id="load">Load</button>
        <span class="pill" id="loaded">not loaded</span>
      </div>

      <textarea id="acode" placeholder="Wklej ACODE tutaj albo wygeneruj w zakładkach Generator / Text outline..."></textarea>

      <div class="row">
        <button class="btn" id="start">Start</button>
        <button class="btn" id="pause">Pause</button>
        <button class="btn" id="resume">Resume</button>
        <button class="btn" id="stop">Stop</button>
        <span class="pill" id="runstate">idle</span>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="box">
      <div class="row">
        <div class="pill">Progress: <span id="progress" class="mono">0/0</span></div>
        <div class="pill">Last: <span id="lastok" class="mono">-</span></div>
      </div>

      <div style="height:10px"></div>

      <div class="mono" style="font-size:16px;">
        <div class="small">Aktualna linia</div>
        <div id="current" style="padding:10px; border:1px solid #eee; border-radius:10px; min-height:44px;"></div>
        <div id="error" class="err" style="margin-top:10px;"></div>
      </div>
    </div>

    <div style="height:12px"></div>

    <!-- Jog / Pen / Steppers -->
    <div class="box">
      <div class="row" style="justify-content: space-between;">
        <div>
          <div style="font-weight:700;">Jog</div>
          <div class="small">Przód/tył = jazda prosto. Lewo/prawo = obrót w miejscu.</div>
        </div>
        <div class="pill">Działa tylko gdy druk jest zatrzymany albo zapauzowany</div>
      </div>

      <div class="divider"></div>

      <div class="jog-wrap">
        <div class="jog-pad">
          <div></div>
          <button class="btn" id="jog_fwd">↑</button>
          <div></div>

          <button class="btn" id="jog_left">←</button>
          <button class="btn" id="jog_stop" title="nic nie wysyła, tylko czyści błąd">■</button>
          <button class="btn" id="jog_right">→</button>

          <div></div>
          <button class="btn" id="jog_back">↓</button>
          <div></div>
        </div>

        <div class="jog-meta">
          <div class="row">
            <label>jog_mm <input id="jog_mm" value="10" inputmode="decimal"></label>
            <label>feed <input id="jog_feed" value="1200" inputmode="numeric"></label>
          </div>
          <div class="row">
            <label>steps_per_mm <input id="steps_per_mm" value="9.142857" inputmode="decimal"></label>
            <span class="small">Jak masz inne, zmień.</span>
          </div>

          <div class="divider"></div>

          <div class="jog-actions">
            <button class="btn" id="pen_up">Pen Up</button>
            <button class="btn dark" id="pen_down">Pen Down</button>

            <span class="pill">Steppers</span>
            <input id="step_en_cmd" value="E 1" style="width:120px" title="komenda enable">
            <button class="btn" id="step_enable">Enable</button>

            <input id="step_dis_cmd" value="E 0" style="width:120px" title="komenda disable">
            <button class="btn" id="step_disable">Disable</button>
          </div>

          <div class="err" id="jogerr"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Generator PNG -->
  <div class="panel" id="panel-generator">
    <div class="gen-vertical">

      <div class="box">
        <div class="row">
          <input type="file" id="png" accept="image/png" />
          <button class="btn" id="gen">Generate</button>
          <span class="pill" id="geninfo">no output</span>
          <span class="err" id="generr"></span>
        </div>

        <div class="divider"></div>

        <div class="gen-settings-scroll">
          <div class="setting-list">

            <div class="setting-item">
              <div class="label"><b>Przejście na kolejną linię</b><span>Tryb zmiany wiersza rastra</span></div>
              <div class="control">
                <select id="line_advance">
                  <option value="default" selected>Obecne</option>
                  <option value="turn90">Klasyczne: obrót 90 + przejazd prostopadły</option>
                </select>
              </div>
            </div>

            <div class="setting-item">
              <div class="label"><b>img_width_mm</b><span>Szerokość wydruku w mm</span></div>
              <div class="control"><input id="img_width_mm" value="120.0" /></div>
            </div>

            <div class="setting-item">
              <div class="label"><b>work_width_px</b><span>Rozdzielczość robocza w px</span></div>
              <div class="control"><input id="work_width_px" value="1600" /></div>
            </div>

            <div class="setting-item">
              <div class="label"><b>line_spacing_mm</b><span>Odstęp między liniami w mm</span></div>
              <div class="control"><input id="line_spacing_mm" value="0.7" /></div>
            </div>

            <div class="setting-item">
              <div class="label"><b>threshold</b><span>0..255, próg jasności</span></div>
              <div class="control"><input id="threshold" value="160" /></div>
            </div>

            <div class="setting-item">
              <div class="label"><b>gamma</b><span>Wzmocnienie kontrastu</span></div>
              <div class="control"><input id="gamma" value="1.0" /></div>
            </div>

            <div class="setting-item">
              <div class="label"><b>min_segment_mm</b><span>Minimalny segment kreski</span></div>
              <div class="control"><input id="min_segment_mm" value="1.0" /></div>
            </div>

            <div class="setting-item">
              <div class="label"><b>y_jitter_mm</b><span>Antybanding</span></div>
              <div class="control"><input id="y_jitter_mm" value="0.04" /></div>
            </div>

            <div class="setting-item">
              <div class="label"><b>seed</b><span>Puste = losowo</span></div>
              <div class="control"><input id="seed" value="" /></div>
            </div>

            <div class="setting-item">
              <div class="label"><b>scan</b><span>serpentine albo ltr</span></div>
              <div class="control">
                <select id="scan">
                  <option value="serpentine" selected>serpentine</option>
                  <option value="ltr">ltr</option>
                </select>
              </div>
            </div>

            <div class="setting-item">
              <div class="label"><b>x_mode</b><span>pixel albo step</span></div>
              <div class="control">
                <select id="x_mode">
                  <option value="pixel" selected>pixel</option>
                  <option value="step">step</option>
                </select>
              </div>
            </div>

            <div class="setting-item">
              <div class="label"><b>x_step_mm</b><span>Używane tylko w trybie step</span></div>
              <div class="control"><input id="x_step_mm" value="0.25" /></div>
            </div>

            <div class="setting-item">
              <div class="label"><b>row_angle_deg</b><span>Skręt przy zmianie wiersza</span></div>
              <div class="control"><input id="row_angle_deg" value="18.0" /></div>
            </div>

            <div class="setting-item">
              <div class="label"><b>soft_min_dy_mm</b><span>Minimalny skok Y</span></div>
              <div class="control"><input id="soft_min_dy_mm" value="0.3" /></div>
            </div>

            <div class="setting-item">
              <div class="label"><b>feed_lin</b><span>Feed dla jazdy prostej</span></div>
              <div class="control"><input id="feed_lin" value="1200" /></div>
            </div>

            <div class="setting-item">
              <div class="label"><b>feed_turn</b><span>Feed dla skrętów</span></div>
              <div class="control"><input id="feed_turn" value="800" /></div>
            </div>

            <div class="setting-item">
              <div class="label"><b>margin_mm</b><span>Margines</span></div>
              <div class="control"><input id="margin_mm" value="0.0" /></div>
            </div>

            <div class="setting-item">
              <div class="label"><b>invert</b><span>Odwróć jasność</span></div>
              <div class="control"><input type="checkbox" id="invert" /></div>
            </div>

            <div class="setting-item">
              <div class="label"><b>flip_y</b><span>Odwróć oś Y</span></div>
              <div class="control"><input type="checkbox" id="flip_y" /></div>
            </div>

            <div class="divider"></div>

            <div class="setting-item">
              <div class="label"><b>viz_dpi</b><span>Podgląd: DPI</span></div>
              <div class="control"><input id="viz_dpi" value="160" /></div>
            </div>

            <div class="setting-item">
              <div class="label"><b>viz_arc_step_mm</b><span>Podgląd: krok łuku w mm</span></div>
              <div class="control"><input id="viz_arc_step_mm" value="1.0" /></div>
            </div>

            <div class="setting-item">
              <div class="label"><b>viz_arc_step_deg</b><span>Podgląd: krok łuku w stopniach</span></div>
              <div class="control"><input id="viz_arc_step_deg" value="1.0" /></div>
            </div>

            <div class="setting-item">
              <div class="label"><b>viz_equal</b><span>Podgląd: zachowaj proporcje</span></div>
              <div class="control"><input type="checkbox" id="viz_equal" /></div>
            </div>

            <div class="setting-item">
              <div class="label"><b>viz_invert_y</b><span>Podgląd: invert Y</span></div>
              <div class="control"><input type="checkbox" id="viz_invert_y" /></div>
            </div>

            <div class="setting-item">
              <div class="label"><b>viz_home_resets_pose</b><span>Podgląd: H resetuje pozycję</span></div>
              <div class="control"><input type="checkbox" id="viz_home_resets_pose" /></div>
            </div>

          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button class="btn" id="push">Push to Sender</button>
          <button class="btn" id="download">Download .acode</button>
        </div>
      </div>

      <div class="preview-fullwidth">
        <div class="box">
          <div class="small">Preview + Symulator (maszyna.png)</div>

          <div class="preview-area" style="margin-top:10px;">
            <img id="previmg" alt="preview" />
            <canvas id="simCanvasGen" class="simCanvas"></canvas>
          </div>

          <div class="sim-controls">
            <button class="btn" id="simPlayGen">Play</button>
            <button class="btn" id="simPauseGen">Pause</button>
            <button class="btn" id="simResetGen">Reset</button>

            <span class="pill">Speed</span>
            <input id="simSpeedGen" type="range" min="0.25" max="6" step="0.25" value="2">
            <span class="pill mono" id="simSpeedValGen">2.00x</span>

            <span class="pill">Frame</span>
            <input id="simScrubGen" type="range" min="0" max="0" step="1" value="0">
            <span class="pill mono" id="simPosGen">0/0</span>

            <span class="pill">Sprite scale</span>
            <input id="simSpriteScaleGen" type="range" min="0.10" max="1.00" step="0.05" value="0.35">
            <span class="pill mono" id="simSpriteScaleValGen">0.35</span>

            <span class="pill">wheelbase</span>
            <span class="pill mono" id="simWheelbaseGen">-</span>
          </div>

          <div class="small">
            Fix na "za duża maszyna":
            szerokość sprite = wheelbase_mm * pxPerMm * sprite_scale,
            plus limit max 30% szerokości podglądu.
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Text outline -->
  <div class="panel" id="panel-text">
    <div class="gen-vertical">

      <div class="box">
        <div class="row">
          <input id="t_text" placeholder="Wpisz tekst" style="flex:1; min-width: 240px;" />
          <button class="btn" id="t_gen">Generate</button>
          <span class="pill" id="t_info">no output</span>
          <span class="err" id="t_err"></span>
        </div>

        <div class="divider"></div>

        <div class="gen-settings-scroll">
          <div class="setting-list">

            <div class="setting-item">
              <div class="label"><b>Przejście na kolejną linię</b><span>Tryb zmiany wiersza rastra</span></div>
              <div class="control">
                <select id="t_line_advance">
                  <option value="default" selected>Obecne</option>
                  <option value="turn90">Klasyczne: obrót 90 + przejazd prostopadły</option>
                </select>
              </div>
            </div>

            <div class="setting-item">
              <div class="label"><b>line_width_mm</b><span>Szerokość wiersza w mm</span></div>
              <div class="control"><input id="t_line_width_mm" value="120.0" /></div>
            </div>

            <div class="setting-item">
              <div class="label"><b>letter_height_mm</b><span>Wysokość litery w mm</span></div>
              <div class="control"><input id="t_letter_height_mm" value="12.0" /></div>
            </div>

            <div class="setting-item">
              <div class="label"><b>stroke_mm</b><span>Grubość obrysu (mm)</span></div>
              <div class="control"><input id="t_stroke_mm" value="0.35" /></div>
            </div>

            <div class="setting-item">
              <div class="label"><b>render_dpi</b><span>DPI renderu konturu</span></div>
              <div class="control"><input id="t_render_dpi" value="600" /></div>
            </div>

            <div class="setting-item">
              <div class="label"><b>font</b><span>Wybierz font</span></div>
              <div class="control">
                <select id="t_font"></select>
              </div>
            </div>

            <div class="divider"></div>

            <div class="setting-item">
              <div class="label"><b>feed_lin</b><span>Feed dla linii</span></div>
              <div class="control"><input id="t_feed_lin" value="1200" /></div>
            </div>

            <div class="setting-item">
              <div class="label"><b>feed_turn</b><span>Feed dla skrętów</span></div>
              <div class="control"><input id="t_feed_turn" value="800" /></div>
            </div>

          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button class="btn" id="t_push">Push to Sender</button>
          <button class="btn" id="t_download">Download .acode</button>
        </div>
      </div>

      <div class="preview-fullwidth">
        <div class="box">
          <div class="small">Preview + Symulator (maszyna.png)</div>

          <div class="preview-area" style="margin-top:10px;">
            <img id="t_previmg" alt="preview" />
            <canvas id="simCanvasText" class="simCanvas"></canvas>
          </div>

          <div class="sim-controls">
            <button class="btn" id="simPlayText">Play</button>
            <button class="btn" id="simPauseText">Pause</button>
            <button class="btn" id="simResetText">Reset</button>

            <span class="pill">Speed</span>
            <input id="simSpeedText" type="range" min="0.25" max="6" step="0.25" value="2">
            <span class="pill mono" id="simSpeedValText">2.00x</span>

            <span class="pill">Frame</span>
            <input id="simScrubText" type="range" min="0" max="0" step="1" value="0">
            <span class="pill mono" id="simPosText">0/0</span>

            <span class="pill">Sprite scale</span>
            <input id="simSpriteScaleText" type="range" min="0.10" max="1.00" step="0.05" value="0.35">
            <span class="pill mono" id="simSpriteScaleValText">0.35</span>

            <span class="pill">wheelbase</span>
            <span class="pill mono" id="simWheelbaseText">-</span>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
  const qs = (id) => document.getElementById(id);

  // Tabs
  document.querySelectorAll(".tab").forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
      document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
      btn.classList.add("active");
      const t = btn.dataset.tab;
      qs("panel-" + t).classList.add("active");
      requestAnimationFrame(() => {
        resizeSim("gen");
        resizeSim("text");
      });
    };
  });

  async function post(url, data) {
    const resp = await fetch(url, { method: "POST", body: data });
    const ct = (resp.headers.get("content-type") || "").toLowerCase();
    const text = await resp.text();

    if (!ct.includes("application/json")) {
      throw new Error("Server returned non-JSON (" + resp.status + "): " + text.slice(0, 200));
    }
    let json;
    try { json = JSON.parse(text); }
    catch (e) { throw new Error("Bad JSON (" + resp.status + "): " + text.slice(0, 200)); }

    if (!resp.ok) throw new Error(json.error || "request failed");
    return json;
  }

  async function getJson(url) {
    const resp = await fetch(url);
    const json = await resp.json();
    if (!resp.ok) throw new Error(json.error || "request failed");
    return json;
  }

  // Sender
  async function loadAcode() {
    const fd = new FormData();
    fd.set("host", qs("host").value.trim());
    fd.set("port", qs("port").value.trim());
    fd.set("acode", qs("acode").value);

    const out = await post("/api/load", fd);
    qs("loaded").textContent = "loaded lines: " + out.lines;
    qs("error").textContent = "";
    qs("current").textContent = "";
    qs("lastok").textContent = "-";
    qs("progress").textContent = "0/" + out.lines;
  }

  qs("load").onclick = () => loadAcode().catch(e => qs("error").textContent = e.message);
  qs("start").onclick = () => post("/api/start", new FormData()).catch(e => qs("error").textContent = e.message);
  qs("pause").onclick = () => post("/api/pause", new FormData()).catch(e => qs("error").textContent = e.message);
  qs("resume").onclick = () => post("/api/resume", new FormData()).catch(e => qs("error").textContent = e.message);
  qs("stop").onclick = () => post("/api/stop", new FormData()).catch(e => qs("error").textContent = e.message);

  // SSE
  const ev = new EventSource("/events");
  ev.onmessage = (e) => {
    const data = JSON.parse(e.data);

    if (data.kind) {
      const { kind, payload } = data;
      if (kind === "line") {
        qs("current").textContent = payload.line;
        qs("error").textContent = "";
        qs("lastok").textContent = "";
        if (payload.total && payload.idx) qs("progress").textContent = payload.idx + "/" + payload.total;
      }
      if (kind === "ok") qs("lastok").textContent = "OK";
      if (kind === "error") qs("error").textContent = payload.msg;
      return;
    }

    const total = data.total ?? 0;
    const idx = data.idx ?? 0;
    qs("progress").textContent = idx + "/" + total;
    if (data.error) qs("error").textContent = data.error;
    qs("runstate").textContent = data.paused ? "paused" : (data.running ? "running" : "idle");
  };

  // Jog helpers
  async function jog(dir) {
    qs("jogerr").textContent = "";
    const fd = new FormData();
    fd.set("host", qs("host").value.trim());
    fd.set("port", qs("port").value.trim());
    fd.set("dir", dir);
    fd.set("jog_mm", qs("jog_mm").value.trim());
    fd.set("steps_per_mm", qs("steps_per_mm").value.trim());
    fd.set("feed", qs("jog_feed").value.trim());
    await post("/api/jog", fd);
  }

  qs("jog_fwd").onclick = () => jog("fwd").catch(e => qs("jogerr").textContent = e.message);
  qs("jog_back").onclick = () => jog("back").catch(e => qs("jogerr").textContent = e.message);
  qs("jog_left").onclick = () => jog("left").catch(e => qs("jogerr").textContent = e.message);
  qs("jog_right").onclick = () => jog("right").catch(e => qs("jogerr").textContent = e.message);
  qs("jog_stop").onclick = () => { qs("jogerr").textContent = ""; qs("error").textContent = ""; };

  qs("pen_up").onclick = () => {
    qs("jogerr").textContent = "";
    const fd = new FormData();
    fd.set("host", qs("host").value.trim());
    fd.set("port", qs("port").value.trim());
    fd.set("mode", "up");
    post("/api/pen", fd).catch(e => qs("jogerr").textContent = e.message);
  };

  qs("pen_down").onclick = () => {
    qs("jogerr").textContent = "";
    const fd = new FormData();
    fd.set("host", qs("host").value.trim());
    fd.set("port", qs("port").value.trim());
    fd.set("mode", "down");
    post("/api/pen", fd).catch(e => qs("jogerr").textContent = e.message);
  };

  qs("step_enable").onclick = () => {
    qs("jogerr").textContent = "";
    const fd = new FormData();
    fd.set("host", qs("host").value.trim());
    fd.set("port", qs("port").value.trim());
    fd.set("cmd", qs("step_en_cmd").value.trim());
    post("/api/steppers", fd).catch(e => qs("jogerr").textContent = e.message);
  };

  qs("step_disable").onclick = () => {
    qs("jogerr").textContent = "";
    const fd = new FormData();
    fd.set("host", qs("host").value.trim());
    fd.set("port", qs("port").value.trim());
    fd.set("cmd", qs("step_dis_cmd").value.trim());
    post("/api/steppers", fd).catch(e => qs("jogerr").textContent = e.message);
  };

  // ----------------------------
  // Simulator (two instances: gen + text)
  // ----------------------------
  function makeSim(prefix, imgId, canvasId, wheelbaseId, posId, scrubId, playId, pauseId, resetId, speedId, speedValId, spriteScaleId, spriteScaleValId) {
    const sim = {
      points: [],
      bounds: null,
      wheelbase_mm: 120,
      invert_y: false,
      equal: false,
      idx: 0,
      playing: false,
      speed: 2.0,
      lastT: 0,
      sprite: null,
      spriteLoaded: false,
      spriteSrcW: 500,
      spriteSrcH: 500,
      headingOffsetRad: -Math.PI / 2,
      spriteScale: 0.35,
      maxSpriteFrac: 0.30
    };

    const canvas = qs(canvasId);
    const img = qs(imgId);

    function resize() {
      if (!canvas || !img) return;
      const r = img.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.max(1, Math.floor(r.width * dpr));
      canvas.height = Math.max(1, Math.floor(r.height * dpr));
      canvas.style.width = r.width + "px";
      canvas.style.height = r.height + "px";
      draw();
    }

    function worldToCanvas(x_mm, y_mm, map) {
      const { xmin, xmax, ymin, ymax } = map.bounds;
      const w = map.w;
      const h = map.h;

      const dx = (xmax - xmin);
      const dy = (ymax - ymin);

      let sx = w / dx;
      let sy = h / dy;

      if (!map.equal) {
        return {
          x: (x_mm - xmin) * sx,
          y: map.invert_y ? (y_mm - ymin) * sy : (h - (y_mm - ymin) * sy),
          sx: sx,
          sy: sy,
          s: null
        };
      }

      const s = Math.min(sx, sy);
      const contentW = dx * s;
      const contentH = dy * s;
      const ox = (w - contentW) * 0.5;
      const oy = (h - contentH) * 0.5;

      const cx = ox + (x_mm - xmin) * s;
      const cyRaw = (y_mm - ymin) * s;
      const cy = map.invert_y ? (oy + cyRaw) : (h - (oy + cyRaw));

      return { x: cx, y: cy, sx: null, sy: null, s: s };
    }

    function currentScalePxPerMm(map) {
      const { xmin, xmax, ymin, ymax } = map.bounds;
      const dx = (xmax - xmin);
      const dy = (ymax - ymin);
      if (map.equal) return Math.min(map.w / dx, map.h / dy);
      return map.w / dx;
    }

    function drawTrail(ctx, map) {
      if (!sim.points || sim.points.length < 2) return;
      ctx.save();
      ctx.lineWidth = 2 * map.dpr;
      ctx.globalAlpha = 0.9;
      ctx.beginPath();
      for (let i = 0; i <= sim.idx; i++) {
        const p = sim.points[i];
        const q = worldToCanvas(p.x, p.y, map);
        if (i === 0) ctx.moveTo(q.x, q.y);
        else ctx.lineTo(q.x, q.y);
      }
      ctx.stroke();
      ctx.restore();
    }

    function drawSprite(ctx, map) {
      if (!sim.points || sim.points.length === 0) return;

      const p = sim.points[sim.idx];
      const q = worldToCanvas(p.x, p.y, map);

      const pxPerMm = currentScalePxPerMm(map);

      // Core sizing + fix:
      // wheelbase_mm * pxPerMm can explode when dx is small,
      // so we apply:
      // - spriteScale slider
      // - max fraction clamp (default 30% of canvas width)
      let spriteW = sim.wheelbase_mm * pxPerMm * sim.spriteScale;
      const maxW = map.w * sim.maxSpriteFrac;
      if (spriteW > maxW) spriteW = maxW;

      const spriteH = spriteW * (sim.spriteSrcH / sim.spriteSrcW);

      const theta = (p.theta || 0) + sim.headingOffsetRad;

      ctx.save();
      ctx.translate(q.x, q.y);
      ctx.rotate(theta);

      if (sim.spriteLoaded) {
        ctx.globalAlpha = 0.95;
        ctx.drawImage(sim.sprite, -spriteW * 0.5, -spriteH * 0.5, spriteW, spriteH);
      } else {
        ctx.globalAlpha = 0.9;
        ctx.fillRect(-spriteW * 0.5, -spriteH * 0.5, spriteW, spriteH);
      }
      ctx.restore();
    }

    function draw() {
      const ctx = canvas.getContext("2d");
      if (!ctx) return;

      ctx.setTransform(1,0,0,1,0,0);
      ctx.clearRect(0,0,canvas.width, canvas.height);

      if (!sim.bounds || !sim.points || sim.points.length === 0) return;

      ctx.strokeStyle = "#000";
      ctx.fillStyle = "#000";

      const map = {
        bounds: sim.bounds,
        w: canvas.width,
        h: canvas.height,
        dpr: window.devicePixelRatio || 1,
        equal: sim.equal,
        invert_y: sim.invert_y
      };

      drawTrail(ctx, map);
      drawSprite(ctx, map);

      qs(posId).textContent = sim.idx + "/" + Math.max(0, sim.points.length - 1);
      qs(scrubId).value = String(sim.idx);
    }

    function tick(ts) {
      if (!sim.playing) return;
      if (!sim.lastT) sim.lastT = ts;
      const dt = Math.max(0, (ts - sim.lastT) / 1000.0);
      sim.lastT = ts;

      const pps = 60 * sim.speed;
      const step = dt * pps;

      let next = sim.idx + step;
      const maxIdx = Math.max(0, sim.points.length - 1);
      if (next >= maxIdx) {
        sim.idx = maxIdx;
        sim.playing = false;
        draw();
        return;
      }
      sim.idx = Math.floor(next);
      draw();
      requestAnimationFrame(tick);
    }

    function play() {
      if (!sim.points || sim.points.length === 0) return;
      sim.playing = true;
      sim.lastT = 0;
      requestAnimationFrame(tick);
    }

    function pause() {
      sim.playing = false;
      sim.lastT = 0;
    }

    function reset() {
      pause();
      sim.idx = 0;
      draw();
    }

    async function loadData(genId) {
      const resp = await fetch("/api/vizdata/" + genId);
      const ct = (resp.headers.get("content-type") || "").toLowerCase();
      const text = await resp.text();
      if (!ct.includes("application/json")) throw new Error("vizdata non-JSON: " + text.slice(0, 200));
      const data = JSON.parse(text);

      sim.points = data.points || [];
      sim.bounds = data.bounds || null;
      sim.wheelbase_mm = (data.settings && data.settings.wheelbase_mm) ? data.settings.wheelbase_mm : 120;
      sim.equal = (data.viz && data.viz.equal) ? true : false;
      sim.invert_y = (data.viz && data.viz.invert_y) ? true : false;

      qs(wheelbaseId).textContent = String(sim.wheelbase_mm.toFixed(2)) + " mm";

      qs(scrubId).max = Math.max(0, sim.points.length - 1);
      qs(scrubId).value = "0";
      qs(posId).textContent = "0/" + Math.max(0, sim.points.length - 1);

      if (!sim.sprite) {
        sim.sprite = new Image();
        sim.sprite.onload = () => {
          sim.spriteLoaded = true;
          sim.spriteSrcW = sim.sprite.naturalWidth || 500;
          sim.spriteSrcH = sim.sprite.naturalHeight || 500;
          draw();
        };
        sim.sprite.onerror = () => { sim.spriteLoaded = false; };
        sim.sprite.src = "/static/maszyna.png";
      }

      resize();
      reset();
    }

    // wiring
    qs(playId).onclick = () => play();
    qs(pauseId).onclick = () => pause();
    qs(resetId).onclick = () => reset();

    qs(speedId).oninput = () => {
      sim.speed = parseFloat(qs(speedId).value || "2");
      qs(speedValId).textContent = sim.speed.toFixed(2) + "x";
    };

    qs(scrubId).oninput = () => {
      pause();
      const v = parseInt(qs(scrubId).value || "0", 10);
      sim.idx = Math.max(0, Math.min(v, Math.max(0, sim.points.length - 1)));
      draw();
    };

    qs(spriteScaleId).oninput = () => {
      sim.spriteScale = parseFloat(qs(spriteScaleId).value || "0.35");
      qs(spriteScaleValId).textContent = sim.spriteScale.toFixed(2);
      draw();
    };

    img.onload = () => { resize(); draw(); };
    window.addEventListener("resize", () => resize());

    return { loadData, resize, reset };
  }

  const simGen = makeSim(
    "gen",
    "previmg", "simCanvasGen",
    "simWheelbaseGen", "simPosGen", "simScrubGen",
    "simPlayGen", "simPauseGen", "simResetGen",
    "simSpeedGen", "simSpeedValGen",
    "simSpriteScaleGen", "simSpriteScaleValGen"
  );

  const simText = makeSim(
    "text",
    "t_previmg", "simCanvasText",
    "simWheelbaseText", "simPosText", "simScrubText",
    "simPlayText", "simPauseText", "simResetText",
    "simSpeedText", "simSpeedValText",
    "simSpriteScaleText", "simSpriteScaleValText"
  );

  function resizeSim(which) {
    if (which === "gen") simGen.resize();
    if (which === "text") simText.resize();
  }

  // ----------------------------
  // Generator PNG
  // ----------------------------
  let lastGenId = "";
  function formVal(id) { return qs(id).value.trim(); }

  async function generatePng() {
    qs("generr").textContent = "";
    const file = qs("png").files[0];
    if (!file) throw new Error("select a PNG first");

    const fd = new FormData();
    fd.set("png", file);

    fd.set("line_advance", qs("line_advance").value);
    fd.set("img_width_mm", formVal("img_width_mm"));
    fd.set("work_width_px", formVal("work_width_px"));
    fd.set("line_spacing_mm", formVal("line_spacing_mm"));
    fd.set("threshold", formVal("threshold"));
    fd.set("gamma", formVal("gamma"));
    fd.set("min_segment_mm", formVal("min_segment_mm"));
    fd.set("y_jitter_mm", formVal("y_jitter_mm"));
    fd.set("seed", formVal("seed"));
    fd.set("scan", qs("scan").value);
    fd.set("x_mode", qs("x_mode").value);
    fd.set("x_step_mm", formVal("x_step_mm"));
    fd.set("row_angle_deg", formVal("row_angle_deg"));
    fd.set("soft_min_dy_mm", formVal("soft_min_dy_mm"));
    fd.set("feed_lin", formVal("feed_lin"));
    fd.set("feed_turn", formVal("feed_turn"));
    fd.set("margin_mm", formVal("margin_mm"));
    if (qs("invert").checked) fd.set("invert", "1");
    if (qs("flip_y").checked) fd.set("flip_y", "1");

    fd.set("viz_dpi", formVal("viz_dpi"));
    fd.set("viz_arc_step_mm", formVal("viz_arc_step_mm"));
    fd.set("viz_arc_step_deg", formVal("viz_arc_step_deg"));
    if (qs("viz_equal").checked) fd.set("viz_equal", "1");
    if (qs("viz_invert_y").checked) fd.set("viz_invert_y", "1");
    if (qs("viz_home_resets_pose").checked) fd.set("viz_home_resets_pose", "1");

    const out = await post("/api/gen", fd);
    lastGenId = out.gen_id;

    qs("geninfo").textContent = "gen_id: " + out.gen_id + " lines: " + out.acode_lines;
    if (out.warnings && out.warnings.length) {
      qs("geninfo").textContent += " warnings: " + out.warnings.join("; ");
    }

    qs("previmg").src = "/preview/" + out.gen_id + ".png?ts=" + Date.now();
    await simGen.loadData(out.gen_id);
  }

  qs("gen").onclick = () => generatePng().catch(e => qs("generr").textContent = e.message);

  qs("push").onclick = async () => {
    qs("generr").textContent = "";
    if (!lastGenId) throw new Error("generate first");
    const fd = new FormData();
    fd.set("host", qs("host").value.trim());
    fd.set("port", qs("port").value.trim());
    const out = await post("/api/push_to_sender", fd);

    qs("acode").value = "loaded from generator (" + out.lines + " lines)\n";
    qs("loaded").textContent = "loaded lines: " + out.lines;

    document.querySelector('.tab[data-tab="sender"]').click();
  };

  qs("download").onclick = () => {
    qs("generr").textContent = "";
    if (!lastGenId) {
      qs("generr").textContent = "generate first";
      return;
    }
    window.location.href = "/download/" + lastGenId + ".acode";
  };

  // ----------------------------
  // Text outline
  // ----------------------------
  let lastTextId = "";

  async function loadFonts() {
    try {
      const out = await getJson("/api/fonts");
      const sel = qs("t_font");
      sel.innerHTML = "";
      out.fonts.forEach(f => {
        const opt = document.createElement("option");
        opt.value = f.path;
        opt.textContent = f.name;
        sel.appendChild(opt);
      });
    } catch (e) {
      // ignore
    }
  }

  async function generateText() {
    qs("t_err").textContent = "";
    const text = qs("t_text").value.trim();
    if (!text) throw new Error("text is empty");

    const fd = new FormData();
    fd.set("text", text);
    fd.set("line_advance", qs("t_line_advance").value);
    fd.set("line_width_mm", qs("t_line_width_mm").value.trim());
    fd.set("letter_height_mm", qs("t_letter_height_mm").value.trim());
    fd.set("stroke_mm", qs("t_stroke_mm").value.trim());
    fd.set("render_dpi", qs("t_render_dpi").value.trim());
    fd.set("font_path", qs("t_font").value);
    fd.set("feed_lin", qs("t_feed_lin").value.trim());
    fd.set("feed_turn", qs("t_feed_turn").value.trim());

    // reuse viz settings from Generator tab
    fd.set("viz_dpi", formVal("viz_dpi"));
    fd.set("viz_arc_step_mm", formVal("viz_arc_step_mm"));
    fd.set("viz_arc_step_deg", formVal("viz_arc_step_deg"));
    if (qs("viz_equal").checked) fd.set("viz_equal", "1");
    if (qs("viz_invert_y").checked) fd.set("viz_invert_y", "1");
    if (qs("viz_home_resets_pose").checked) fd.set("viz_home_resets_pose", "1");

    const out = await post("/api/text_outline", fd);
    lastTextId = out.gen_id;

    qs("t_info").textContent = "gen_id: " + out.gen_id + " lines: " + out.acode_lines;
    if (out.warnings && out.warnings.length) {
      qs("t_info").textContent += " warnings: " + out.warnings.join("; ");
    }

    qs("t_previmg").src = "/preview/" + out.gen_id + ".png?ts=" + Date.now();
    await simText.loadData(out.gen_id);
  }

  qs("t_gen").onclick = () => generateText().catch(e => qs("t_err").textContent = e.message);

  qs("t_push").onclick = async () => {
    qs("t_err").textContent = "";
    if (!lastTextId) throw new Error("generate first");
    const fd = new FormData();
    fd.set("host", qs("host").value.trim());
    fd.set("port", qs("port").value.trim());
    const out = await post("/api/push_to_sender", fd);

    qs("acode").value = "loaded from text outline (" + out.lines + " lines)\n";
    qs("loaded").textContent = "loaded lines: " + out.lines;

    document.querySelector('.tab[data-tab="sender"]').click();
  };

  qs("t_download").onclick = () => {
    qs("t_err").textContent = "";
    if (!lastTextId) {
      qs("t_err").textContent = "generate first";
      return;
    }
    window.location.href = "/download/" + lastTextId + ".acode";
  };

  loadFonts();
</script>
</body>
</html>
